#+title Emacs Configuration
#+PROPERTY: header-args:emacs-lisp :tangle ~/.emacs.d/init.el

* Globals

Custom file:
#+begin_src emacs-lisp
  (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
  (load custom-file)
#+end_src

Some /globals/:
#+begin_src emacs-lisp
  (setq
   inhibit-startup-message t
   visible-bell t

   ;; Put all backup files here (those that end on a ~).
   backup-directory-alist '(("" . "~/.emacs.d/backup"))

   ;; Smoother scrolling from: https://www.emacswiki.org/emacs/SmoothScrolling
   scroll-step 1
   scroll-conservatively 10000
   scroll-margin 20 ;; In number of lines

   ;; Disable
   auto-save-default nil

   ;; No backup files, please
   make-backup-files nil

   ;; Make it easy to cycle through previous items in the mark ring
   set-mark-command-repeat-pop t

   ;; Don't warn on large files
   large-file-warning-threshold nil

   ;; Don't warn on advice
   ad-redefinition-action 'accept

   ;; Revert Dired and other buffers
   global-auto-revert-non-file-buffers t

   ;; Silence compiler warnings as they can be pretty disruptive
   native-comp-async-report-warnings-errors nil

   ;; Indentation cannot insert tabs
   indent-tabs-mode nil
   tab-width 2

   ;; One can instruct Emacs to always resolve symlinks, at a performance cost
   find-file-visit-truename t

   ;; Tell global-auto-revert-mode to act also on Dired buffers
   global-auto-revert-non-file-buffers t

   ;; Focus on help window
   help-window-select t

   ;; Keep point at the same screen position when scrolling up and down pages.
   scroll-preserve-screen-position t)
#+end_src

Some /buffer-local/ defaults:
#+begin_src emacs-lisp
  (setq-default
   ;; Regardless of whether auto-fill is enabled, we always have 80 columns.
   fill-column 80

   ;; Relative line numbers
   ;; display-line-numbers 'relative
   )
#+end_src

Personal key maps:
#+begin_src emacs-lisp :tangle no
  (defvar-keymap my-other-map)
  (keymap-set global-map "C-o" my-other-map)

  (defvar-keymap my-search-map)
  (keymap-set global-map "C-s" my-search-map)

  (defvar-keymap my-toggle-map
    "l" 'display-line-numbers-mode)
  (keymap-set global-map "C-t" my-toggle-map)
#+end_src

By default, we must hit escape three times to quit anything. Make it only once:
#+begin_src emacs-lisp
  (global-set-key (kbd "<escape>") 'keyboard-escape-quit)
#+end_src

Some global hooks:
#+begin_src emacs-lisp :tangle no
  ;; In all modes, delete trailing whitespaces before saving.
  (add-hook 'before-save-hook #'delete-trailing-whitespace)
#+end_src

* Package management

Configure package repositories:
/(Not needed since we are using =straight.el= for package management)/

#+begin_src emacs-lisp :tangle no
  (require 'package)
  (setq package-archives '(("melpa" . "https://melpa.org/packages/")
                           ("org" . "https://orgmode.org/elpa/")
                           ("elpa" . "https://elpa.gnu.org/packages/")))
  (package-initialize)
#+end_src

Install the =straight.el= package manager:

#+begin_src emacs-lisp
  (defvar bootstrap-version)
  (let ((bootstrap-file
  	 (expand-file-name
  	  "straight/repos/straight.el/bootstrap.el"
  	  (or (bound-and-true-p straight-base-dir)
  	      user-emacs-directory)))
  	(bootstrap-version 7))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
  	  (url-retrieve-synchronously
  	   "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
  	   'silent 'inhibit-cookies)
  	(goto-char (point-max))
  	(eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
#+end_src

Install =use-package= via =straight.el=:

#+begin_src emacs-lisp
  ;; Integrate straight.el with use-package
  (straight-use-package '(use-package :host github :repo "emacs-straight/use-package"))
#+end_src

Tell =straight.el= to ensure all my packages are installed by default:

#+begin_src emacs-lisp
  ;; Add :straight t to all my packages so they are installed by default
  (setq straight-use-package-by-default t)
#+end_src

Together with use-package, =:diminish= can hide minor modes from the mode line.

#+begin_src emacs-lisp
  ;; Add :diminish to keep minor modes out of the mode line.
  (use-package diminish
    :demand t)
#+end_src

* Help
#+begin_src emacs-lisp
  (use-package helpful
    :ensure t
    :bind
    ;; Replace default help commands
    ([remap describe-function] . helpful-callable)
    ([remap describe-command] . helpful-command)
    ([remap describe-variable] . helpful-variable)
    ([remap describe-key]      . helpful-key))
#+end_src

* Built-in global modes

Global modes that come installed with Emacs:

#+begin_src emacs-lisp
  ;; Enable repeating key maps
  (repeat-mode t)

  ;; Hide the menu bar
  (menu-bar-mode 0)

  ;; Hide the tool bar
  (tool-bar-mode 0)

  ;; Hide the scroll bar
  (scroll-bar-mode 0)

  ;; Enable mouse events in terminal Emacs
  (xterm-mouse-mode t)

  ;; Display time in mode line / tab bar
  (display-time-mode t)

  ;; Improved vertical minibuffer completions
  (fido-vertical-mode 0)

  ;; Show column number on mode line
  (column-number-mode t)

  ;; Remember previous tab window configurations
  (tab-bar-history-mode t)

  ;; (Disable) Auto-save files at an interval
  (auto-save-visited-mode 0)

  ;; Visually wrap long lines in all buffers
  (global-visual-line-mode t)

  ;; Refresh buffers with changed local files
  (global-auto-revert-mode t)

  ;; To navigate window configuration history
  (winner-mode t)

  ;; When this global minor mode is enabled, Emacs displays help
  ;; text (e.g. for buttons and menu items that you put the mouse on)
  ;; in a pop-up window.
  (tooltip-mode t)

  ;; Disable line numbers on the left by default
  (global-display-line-numbers-mode 0)

  ;; Show column number at the bottom next to the line number.
  (column-number-mode t)

  ;; Refresh buffers automatically.
  (global-auto-revert-mode t)

  ;; Save place in each file.
  (save-place-mode t)

  ;; Break lines at right margin.
  (auto-fill-mode t)
#+end_src

#+begin_src emacs-lisp
  (use-package imenu
    :straight nil ; Built-in
    :demand t
    :custom
    ; Always rescan the buffers (also recommended by Treemacs)
    (imenu-auto-rescan t))
#+end_src

From =recentf-mode=:
  By default, only operations like opening a file, writing a buffer
  to a file, and killing a buffer is counted as "operating" on
  the file.  If instead you want to prioritize files that appear in
  buffers you switch to a lot, you can say something like the following:

#+begin_src emacs-lisp
  (use-package recentf
    :straight nil ; Built-in
    :demand t
    :config
    (recentf-mode t)
    (add-hook 'buffer-list-update-hook #'recentf-track-opened-file))
#+end_src

#+begin_src emacs-lisp
  ;; Persist history over Emacs restarts
  ;; Vertico sorts by history position
  (use-package savehist
    :straight nil ; Built-in
    :demand t
    :custom
    (savehist-save-minibuffer-history t)
    :config
    (savehist-mode t)

    ;; Variables here must be printable with the Lisp printer.
    ;; Seems like ones defined in C cannot be saved.
    (add-to-list 'savehist-additional-variables  'compile-command)
    (add-to-list 'savehist-additional-variables  'command-history)
    (add-to-list 'savehist-additional-variables  'kill-ring))
#+end_src

#+begin_src emacs-lisp
  (use-package replace
    :straight nil ; Built-in
    :demand t
    :custom-face
    (list-matching-lines-face ((t (:background "yellow" :foreground "black")))))
#+end_src

* Keyboard shortcuts

#+begin_src emacs-lisp :tangle no
  (use-package general
    :config
    (general-create-definer my/leader
                            :states '(normal visual emacs)
                            :keymaps 'override
                            :prefix "SPC"
                            :global-prefix "C-SPC"))
#+end_src

#+begin_src emacs-lisp
  (use-package transient
    :demand t)
#+end_src

** Files and buffers transients
#+begin_src emacs-lisp
  (transient-define-prefix my/files-transient ()
    "File-related commands."
    [["Open"
      ("f" "Find file" find-file)
      ("F" "Find file other" find-file-other-window)
      ("r" "Recent file" consult-recent-file)]
     ["Dired"
      ("d" "Dired here" dired)
      ("D" "Dired other" dired-other-window)]])

  (transient-define-prefix my/buffers-transient ()
    "Buffer-related commands."
    [["Switch"
      ("b" "Switch buffer" consult-buffer)
      ("B" "Switch buffer other" consult-buffer-other-window)]
     ["Manage"
      ("k" "Kill buffer" kill-current-buffer)
      ("K" "Kill other buffers" kill-buffer)]])
#+end_src

** OCaml transient
#+begin_src emacs-lisp
  (defun my/dune--compile (cmd)
    "Run dune CMD with `compile' in the current `default-directory'."
    (compile (format "dune %s" cmd)))

  (defun my/dune-init-project (name dir)
    "Initialize a dune project NAME in DIR, using a relative path if possible."
    (interactive
     (let* ((abs-dir (directory-file-name
  		    (read-directory-name "Directory: " default-directory)))
  	  (rel-dir (file-relative-name abs-dir default-directory)))
       (list
        (read-string
         "Project name: "
         (file-name-nondirectory
  	(directory-file-name default-directory)))
        rel-dir)))
    (compile (format "dune init project %s %s" name dir)))

  (transient-define-prefix my/ocaml-dune-transient ()
    "OCaml/Dune commands"
    [["Init"
      ("n" "Init proj here" my/dune-init-project)]])
#+end_src

** Project transient
#+begin_src emacs-lisp
  (transient-define-prefix my/project-transient ()
    "Project commands."
    [["Switch / Find"
      ("p" "Switch project" project-switch-project)
      ("fm" "find others"
       (lambda ()
         (interactive)
         (let* ((project-root (projectile-acquire-root))
  	      (initial (concat (file-name-base buffer-file-name) "\\."))
  	      (file (projectile-completing-read "Find file: "
  						(projectile-project-files project-root)
  						:initial-input initial)))
  	 (when file
  	   (find-file (expand-file-name file project-root))
  	   (run-hooks 'projectile-find-file-hook)))))
      ("ff" "Find file"      project-find-file)
      ("b" "Switch buffer"  consult-project-buffer)] ;; or project-switch-to-buffer
     ["Search"
      ("s" "Search (rg/ag)" consult-ripgrep)
      ("l" "Search line"    consult-line-multi)
      ("g" "Grep"           project-find-regexp)]
     ["Build / Run"
      ;; adapt these to TAPL/OCaml projects later
      ("c" "Compile"        compile)
      ("t" "Test"           recompile)]])
#+end_src

** Git transient
#+begin_src emacs-lisp
  (transient-define-prefix my/git-transient ()
    "Git transient"
    ["Hunks"
     ("j" "next hunk" git-gutter:next-hunk :transient t)
     ("k" "prev hunk" git-gutter:previous-hunk :transient t)]
    ["Actions"
     ("g" "magit" magit)])
#+end_src

** Toggles transient
#+begin_src emacs-lisp
  (transient-define-prefix my/toggles-transient ()
    "Toggles transient"
    ["Toggles"
     ("t" "treemacs" treemacs)
     ("s" "LSP symbols"
      (lambda ()
        (interactive)
        (let* ((buffer-name "*LSP Symbols List*")
              (exists (get-buffer buffer-name)))
          (if exists (kill-buffer buffer-name)
            (lsp-treemacs-symbols)))) :transient t)
     ("l" "line numbers" display-line-numbers-mode :transient t)])
#+end_src

** Org transient
#+begin_src emacs-lisp
  (transient-define-prefix my/org-transient ()
    "Org actions."
    [["Capture / TODO"
      ("c" "Capture" org-capture)
      ("t" "Todo"    org-todo)
      ("s" "Schedule" org-schedule)]
     ["Structure"
      ("m" "Meta-return" org-meta-return)
      ("h" "Promote"     org-do-promote)
      ("l" "Demote"      org-do-demote)
      ("u" "Move up"     org-move-subtree-up)
      ("d" "Move down"   org-move-subtree-down)]
     ["Navigate"
      ("a" "Agenda" org-agenda)
      ("g" "Goto heading" consult-org-heading)]])
#+end_src

** Org-roam transient
#+begin_src emacs-lisp
  (transient-define-prefix my/roam-transient ()
    "Org-roam commands."
    [["Find / Insert"
      ("f" "Find node"   org-roam-node-find)
      ("i" "Insert node" org-roam-node-insert)]
     ["Dailies"
      ("t" "Today"   org-roam-dailies-goto-today)
      ("y" "Yesterday" org-roam-dailies-goto-yesterday)
      ("d" "Date"    org-roam-dailies-goto-date)]
     ["Graph / Utils"
      ("g" "Graph" org-roam-graph)
      ("r" "Refresh DB" org-roam-db-sync)]])
#+end_src

** Global hub transient
#+begin_src emacs-lisp
  (transient-define-prefix my/hub-transient ()
    "Main command hub."
    [["Files / Buffers"
      ("f" "Files"   my/files-transient)
      ("b" "Buffers" my/buffers-transient)]
     ["Projects"
      ("p" "Project" my/project-transient)]
     ["Org"
      ("o" "Org"     my/org-transient)]
     ["Roam"
      ("r" "Roam"    my/roam-transient)]
     ["Dune"
      ("d" "Dune"    my/ocaml-dune-transient)]
     ["Git"
      ("g" "Git"    my/git-transient)]
     ["Toggles"
      ("t" "Toggles" my/toggles-transient)]
     ])
#+end_src

** Other
#+begin_src emacs-lisp :tangle no
  (transient-define-prefix major-mode-transient ()
    "Major Mode transient"
    ["Compilation"
     ("d" "disaster" disaster :if-mode c-mode)])
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package key-chord
     :after evil
     :config
     (key-chord-define-global "jk" 'evil-normal-state)
     (key-chord-define-global "df" 'entry-transient)
     (key-chord-mode t))
#+end_src


* Global modes

Global modes that do not come with Emacs.

#+begin_src emacs-lisp
  (use-package embark
    :bind
    (("C-." . embark-act)))

  (use-package embark-consult)
#+end_src

#+begin_src emacs-lisp
  (defun mode-line-render ()
    (let ((face '((normal . "gray20")
  		(visual . "SteelBlue")
  		(replace . "Magenta")
  		(operator . "Magenta")
  		(motion . "Magenta")
  		(emacs . "Magenta")
  		(insert . "SeaGreen")))
  	(state (symbol-value 'evil-state)))
      (set-face-attribute 'mode-line nil
  			:background (cdr (assoc state face)))))

  (use-package evil
    :demand t
    :custom
    (evil-want-keybinding nil) ; For evil-collection
    (evil-mode-line-format nil) ; Hide. Personal preference
    :bind (:map evil-motion-state-map
  	      ("C-y" . consult-yank-from-kill-ring)
  	      :map evil-insert-state-map
  	      ("C-y" . consult-yank-from-kill-ring)
  	      :map evil-visual-state-map
  	      ("C-w" . kill-region)
  	      :map evil-normal-state-map
  	      ("SPC" . #'my/hub-transient)
  	      ("C-w" . kill-region)
  	      ("/" . consult-line))
    :config
    (evil-mode t)

    ;; evil-define-key delays execution until keymap is loaded.
    (evil-define-key 'insert vertico-map (kbd "C-j") 'vertico-next)
    (evil-define-key 'insert vertico-map (kbd "C-k") 'vertico-previous)

    (add-hook 'post-command-hook #'mode-line-render))
#+end_src

#+begin_src emacs-lisp
  (use-package evil-collection
    :after evil
    :demand t
    :custom
    (evil-collection-setup-minibuffer t) ; Opt-in
    (evil-collection-outline-bind-tab-p t) ; tab maps to outline-cycle
    :config
    (evil-collection-init))
#+end_src

#+begin_src emacs-lisp
  ;; Helps visualise colors when editing themes and such
  (use-package rainbow-mode)
#+end_src

#+begin_src emacs-lisp
  (use-package keycast
    :demand t ; Demand because we bind keys below and want them always available
    :custom
    (keycast-mode-line-insert-after 'mode-line-buffer-identification)
    (keycast-mode-line-remove-tail-elements nil))
#+end_src

#+begin_src emacs-lisp
  (use-package which-key
    :demand t
    :diminish
    :config
    (which-key-mode t))
#+end_src

#+begin_src emacs-lisp :tangle no
  (setq load-path (cons (expand-file-name "~/devel/ott/emacs") load-path))
  (require 'ott-mode)
#+end_src

#+begin_src emacs-lisp :tangle no
  (load "~/devel/HOL/tools/hol-mode")
  (load "~/devel/HOL/tools/hol-unicode")
#+end_src

#+begin_src emacs-lisp
  (use-package yasnippet
    :demand t
    :diminish yas-minor-mode
    :config
    (yas-global-mode t))

  (use-package yasnippet-snippets
    :diminish
    :after yasnippet)
#+end_src

When there are two windows, =ace-window= will call other-window (unless
aw-dispatch-always is set non-nil). If there are more, each window will have the
first character of its window label highlighted at the upper left of the window.

#+begin_src emacs-lisp
  (use-package ace-window
    :demand t
    :bind
    ("M-o" . #'ace-window))
#+end_src

[[https://github.com/DevelopmentCool2449/colorful-mode][Colorful Mode]] helps to visualise colors:

#+begin_src emacs-lisp
  (use-package colorful-mode
    :custom
    (colorful-use-prefix t)
    (colorful-only-strings 'only-prog)
    (css-fontify-colors nil)
    :config
    (add-to-list 'colorful-extra-color-keyword-functions
                 ;; Work with color names in Org
                 '(org-mode . (colorful-add-color-names)))
    :hook
    (org-mode . colorful-mode))
#+end_src

* Theme

#+begin_src emacs-lisp
  (load-theme 'wombat t) ;; t is for "safe"

  (custom-set-faces
   '(highlight ((t (:inherit region :background "#556b2f"))))
   '(hl-line ((t (:inherit highlight))))
   '(line-number ((t (:inherit (shadow default) :background "#2e2e2e")))))
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package modus-themes
    :demand t
    :config
    ;; Add all your customizations prior to loading the themes
    ;;(setq modus-themes-italic-constructs t
    ;;      modus-themes-bold-constructs nil)

    ;; Maybe define some palette overrides, such as by using our presets
    ;; (setq modus-themes-common-palette-overrides
    ;;      modus-themes-preset-overrides-intense)

    ;; Load the theme of your choice.
    (modus-themes-load-theme 'modus-operandi-tinted)

    ;; We have a key mapping to toggle between dark and light themes
    (setq modus-themes-to-toggle '(modus-operandi-tinted modus-vivendi))

    (define-key global-map (kbd "<f5>") #'modus-themes-rotate))

  (set-fringe-style 20) ; Set a fringe on left and right (in pixels)
#+end_src

Mode line:

Original, just for reference:

#+begin_src emacs-lisp :tangle no
  (setq-default mode-line-format '("%e" mode-line-front-space
                                   (:propertize
                                    ("" mode-line-mule-info mode-line-client mode-line-modified mode-line-remote
                                     mode-line-window-dedicated)
                                    display (min-width (6.0)))
                                   mode-line-frame-identification mode-line-buffer-identification "   "
                                   mode-line-position (project-mode-line project-mode-line-format)
                                   (vc-mode vc-mode) "  " mode-line-modes mode-line-misc-info mode-line-end-spaces))
#+end_src

Ours:

#+begin_src emacs-lisp
  (setq-default mode-line-format
                '("%e" mode-line-front-space

                  (:propertize
                   ("" mode-line-modified mode-line-window-dedicated)
                   display (min-width (6.0)))

                  mode-line-frame-identification mode-line-buffer-identification
                  "   "
                  mode-line-position (project-mode-line project-mode-line-format)
                  (vc-mode vc-mode)
                  "   "
                  mode-line-modes))
#+end_src

* Emacs Configuration

Auto-tangle configuration files when we save this org file.

#+begin_src emacs-lisp
  ;; Automatically tangle our emacs.org config file when we save it.
  (defun org-babel-tangle-config ()
    (when (string-equal (buffer-file-name)
                        (expand-file-name "~/devel/dotfiles/emacs/emacs.org"))
      (let ((org-confirm-babel-evaluate nil))
        (org-babel-tangle))))

  (add-hook 'org-mode-hook (lambda ()
                             (add-hook 'after-save-hook
                                       'org-babel-tangle-config)))
#+end_src

Here is a function that we can bind to a keybinding. It reloads our =~/.emacs=.

#+begin_src emacs-lisp
  (defun reload-dotemacs ()
    (interactive)
    (load-file "~/.emacs.d/init.el"))

  ;; Reload our ~/.emacs.
  (global-set-key (kbd "C-c <f12>") #'reload-dotemacs)
#+end_src

* Completion

Company for in-buffer completion.

#+begin_src emacs-lisp
  (use-package company
    :config
    (global-company-mode t))
#+end_src

* Minibuffer completion
** Ivy (disabled)

Ivy is disabled at the moment in favour of Vertico.

#+begin_src emacs-lisp :tangle no
  (use-package ivy
    :disabled
    :diminish
    :bind (("C-s" . swiper)
           ("C-x b" . ivy-switch-buffer)
           ("C-x C-b" . ivy-switch-buffer))
    :config
    ;; Always enabled.
    (ivy-mode 1)
    :init
    ;; Add files and bookmarks to switch-buffer prompt.
    (setq ivy-use-virtual-buffers t)
    (setq ivy-count-format "(%d/%d) "))

  ;; Prescient to sort auto-completion by recency.
  (use-package ivy-prescient
    :disabled
    :diminish
    :config
    (ivy-prescient-mode 1))
#+end_src

** Vertico and friends

#+begin_src emacs-lisp
  (use-package vertico
    :demand t
    :hook
    ;; Works with =file-name-shadow-mode= enabled.
    (rfn-eshadow-update-overlay . vertico-directory-tidy)
    :config
    (vertico-mode t))
#+end_src

Marginalia for annotations in the minibuffer.

#+begin_src emacs-lisp
  (use-package marginalia
    :demand t
    :config
    (marginalia-mode t))
#+end_src

Consult provides search and navigation commands.

#+begin_src emacs-lisp
  (use-package consult
    :demand t
    :hook
    ;; Enable automatic preview at point in the *Completions* buffer.
    (completion-list-mode . consult-preview-at-point-mode)
    :bind (("C-y" . consult-yank-from-kill-ring)))
#+end_src

Orderless allows me to search word parts in any order.

#+begin_src emacs-lisp
  (use-package orderless
    :demand t
    :init
    ;; Configure a custom style dispatcher (see the Consult wiki)
    ;; (setq orderless-style-dispatchers '(+orderless-consult-dispatch orderless-affix-dispatch)
    ;;       orderless-component-separator #'orderless-escapable-split-on-space)
    (setq completion-styles '(orderless basic)
          completion-category-defaults nil
          completion-category-overrides '((file (styles partial-completion)))))
#+end_src

* Projects

#+begin_src emacs-lisp
  (use-package projectile
    :demand t
    :diminish projectile-mode
    :bind (
           :map projectile-mode-map
  	            ("C-c p" . projectile-command-map))
    :init
    (when (file-directory-p "~/devel")
      (setq projectile-project-search-path '("~/devel")))
    :config
    (projectile-mode t)

    ;; Open project in dired by default
    (setq projectile-switch-project-action 'projectile-dired)

    (add-to-list 'projectile-other-file-alist '("c" "objdump")))
#+end_src

Disable =counsel-projectile= if using Vertico + Consult instead of Ivy.

#+begin_src emacs-lisp :tangle no
  (use-package counsel-projectile
    :disabled
    :after projectile
    :config
    (counsel-projectile-mode))
#+end_src

#+begin_src emacs-lisp
  (use-package editorconfig
    :demand t
    :diminish
    :config
    (editorconfig-mode t))
#+end_src

* Search

#+begin_src emacs-lisp :tangle no
  (use-package ripgrep)
#+end_src

* Language Server Protocol (LSP)

Vanilla =lsp-mode=:

#+begin_src emacs-lisp
  (use-package lsp-mode
    :commands (lsp lsp-deferred)

    :init
    (setq lsp-keymap-prefix "C-c l")  ;; Or 'C-l', 's-l'

    :config
    (lsp-enable-which-key-integration t)

    :hook (;; Enable languages here:
           (c-mode . lsp-deferred)
           (tuareg-mode . lsp-deferred)
           (go-mode . lsp-deferred)
           (shell-script-mode . lsp-deferred)))
#+end_src

Optional packages to support =lsp-mode=:

#+begin_src emacs-lisp
  (use-package lsp-ui
    :commands lsp-ui-mode)
#+end_src

#+begin_src emacs-lisp
  (use-package flycheck
    :hook
    (lsp-mode . flycheck-mode))
#+end_src

* Treemacs

[[https://github.com/Alexander-Miller/treemacs][Treemacs]] - a tree layout file explorer for Emacs:
#+begin_src emacs-lisp
  (use-package treemacs
    :config
    (treemacs-follow-mode 0)
    (setq treemacs-space-between-root-nodes nil)
    :bind (
           ("M-0"       . treemacs-select-window)
           ("C-x t 1"   . treemacs-delete-other-windows)
           ("C-x t t"   . treemacs)
           ("C-x t d"   . treemacs-select-directory)
           ("C-x t B"   . treemacs-bookmark)
           ("C-x t C-t" . treemacs-find-file)
           ("C-x t M-t" . treemacs-find-tag))
    :demand t)
#+end_src

Optionals:

#+begin_src emacs-lisp
  ;; Allows treemacs icons in dired buffers.
  (use-package treemacs-icons-dired
    :demand t
    :after dired
    :hook
    (dired-mode . treemacs-icons-dired-enable-once))

  ;; Integration between lsp-mode and treemacs
  (use-package lsp-treemacs
    :after (treemacs lsp))

  ;; Allows to quickly add your projectile projects to the treemacs workspace.
  (use-package treemacs-projectile
    :after (treemacs projectile))

  ;; It will inform treemacs about (un)staging of files and commits happening in magit.
  (use-package treemacs-magit
    :after (treemacs magit))
#+end_src

* Tree Sitter

Configure some ~tree-sitter~ grammars locations:

#+begin_src emacs-lisp :tangle no
  (setq treesit-language-source-alist
     '((bash "https://github.com/tree-sitter/tree-sitter-bash")
       (cmake "https://github.com/uyha/tree-sitter-cmake")
       (css "https://github.com/tree-sitter/tree-sitter-css")
       (elisp "https://github.com/Wilfred/tree-sitter-elisp")
       (go "https://github.com/tree-sitter/tree-sitter-go")
       (html "https://github.com/tree-sitter/tree-sitter-html")
       (javascript "https://github.com/tree-sitter/tree-sitter-javascript" "master" "src")
       (json "https://github.com/tree-sitter/tree-sitter-json")
       (make "https://github.com/alemuller/tree-sitter-make")
       (markdown "https://github.com/ikatyang/tree-sitter-markdown")
       (python "https://github.com/tree-sitter/tree-sitter-python")
       (toml "https://github.com/tree-sitter/tree-sitter-toml")
       (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
       (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
       (yaml "https://github.com/ikatyang/tree-sitter-yaml")
       (c "https://github.com/tree-sitter/tree-sitter-c")))
#+end_src

* Compilation

Configurations for the compilation buffer:

#+begin_src emacs-lisp
  (setq-default next-error-message-highlight t)
  (setq-default compilation-window-height 20)
#+end_src

* Programming Environments
** Publishing
#+begin_src emacs-lisp
  (use-package simple-httpd
    :ensure t)
#+end_src
** Git

#+begin_src emacs-lisp :tangle no
  ;; https://github.com/emacsorphanage/git-gutter
  (use-package git-gutter
    :diminish
    :hook
    ;; Enable in all modes that inherit from prog-mode.
    (prog-mode . git-gutter-mode)
    (org-mode . git-gutter-mode)
    :config
    ;; Interval in seconds.
    (setq git-gutter:update-interval 1))
#+end_src

#+begin_src emacs-lisp
  ;; https://github.com/emacsorphanage/git-gutter-fringe
  (use-package git-gutter-fringe
    :config
    ;; Green
    (define-fringe-bitmap 'git-gutter-fr:added [224] nil nil '(center repeated))
    ;; Purple
    (define-fringe-bitmap 'git-gutter-fr:modified [224] nil nil '(center repeated))
    ;; Red
    (define-fringe-bitmap 'git-gutter-fr:deleted [128 192 224 240] nil nil 'bottom)

    (set-face-foreground 'git-gutter-fr:modified "purple")
    (set-face-foreground 'git-gutter-fr:added    "green")
    (set-face-foreground 'git-gutter-fr:deleted  "red"))
#+end_src

#+begin_src emacs-lisp
  (use-package magit
    :custom
    ; By default, Magit opens status in a new window.
    (magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1))
#+end_src

** Lisp

#+begin_src emacs-lisp
  ;; We enable eldoc only for Lisp
  (use-package eldoc
    :straight nil ; Built-in
    :hook
    (emacs-lisp-mode . eldoc-mode)
    (lisp-mode . eldoc-mode)
    (lisp-interaction-mode . eldoc-mode)
    :config
    (global-eldoc-mode 0))
#+end_src

#+begin_src emacs-lisp
  (use-package paredit
    :hook
    (emacs-lisp-mode . eldoc-mode)
    (lisp-mode . paredit-mode)
    (lisp-interaction-mode . paredit-mode))

  (use-package rainbow-delimiters
    :config
    ;; Set faces for error and levels
    (dolist (face '((rainbow-delimiters-base-error-face . "magenta")
                    (rainbow-delimiters-depth-1-face    . "gold")
                    (rainbow-delimiters-depth-2-face    . "spring green")
                    (rainbow-delimiters-depth-3-face    . "dark salmon")
                    (rainbow-delimiters-depth-4-face    . "tomato")
                    (rainbow-delimiters-depth-5-face    . "hot pink")
                    (rainbow-delimiters-depth-6-face    . "peach puff")))
      (set-face-attribute (car face) nil
                          :foreground (cdr face)))

    :hook
    (emacs-lisp-mode . eldoc-mode)
    (lisp-mode . rainbow-delimiters-mode)
    (lisp-interaction-mode . rainbow-delimiters-mode))
#+end_src

** OCaml

#+begin_src emacs-lisp
  (use-package opam-switch-mode
    :ensure t
    :hook
    ((tuareg-mode) . opam-switch-mode))
#+end_src

Use packages from Opam:

```
opam install ocaml-lsp-server ocamlformat merlin tuareg utop ocp-index
```

#+begin_src emacs-lisp
  (defun opam-shell-command-to-string (command)
    "Similar to shell-command-to-string, but returns nil unless the process
        returned 0, and ignores stderr (shell-command-to-string ignores return value)"
    (let* ((return-value 0)
           (return-string
            (with-output-to-string
              (setq return-value
                    (with-current-buffer standard-output
                      (process-file shell-file-name nil '(t nil) nil
                                    shell-command-switch command))))))
      (if (= return-value 0) return-string nil)))

  (defun opam-update-env (switch)
    "Update the environment to follow current OPAM switch configuration"
    (interactive
     (list
      (let ((default
             (car (split-string (opam-shell-command-to-string "opam switch show --safe")))))
        (completing-read
         (concat "opam switch (" default "): ")
         (split-string (opam-shell-command-to-string "opam switch list -s --safe") "\n")
         nil t nil nil default))))
    (let* ((switch-arg (if (= 0 (length switch)) "" (concat "--switch " switch)))
           (command (concat "opam env --safe --sexp " switch-arg))
           (env (opam-shell-command-to-string command)))
      (when (and env (not (string= env "")))
        (dolist (var (car (read-from-string env)))
          (setenv (car var) (cadr var))
          (when (string= (car var) "PATH")
            (setq exec-path (split-string (cadr var) path-separator)))))))

  (defun opam-switch (switch)
    "Change OPAM switch"
    (interactive
     (list
      (let ((default
             (car (split-string (opam-shell-command-to-string "opam switch show --safe")))))
        (completing-read
         (concat "opam switch (" default "): ")
         (split-string (opam-shell-command-to-string "opam switch list -s --safe") "\n")
         nil t nil nil default))))
    (progn (setenv "OPAMSWITCH" switch)
           (opam-update-env switch)))

  (defvar opam-share
    (let ((reply (opam-shell-command-to-string "opam var share --safe")))
      (when reply (substring reply 0 -1))))

  ;; Load Emacs packages installed with opam
  (add-to-list 'load-path (concat opam-share "/emacs/site-lisp"))

  (defun opam-setup-add-ocaml-hook (h)
    (add-hook 'tuareg-mode-hook h t)
    (add-hook 'caml-mode-hook h t))

  (defun opam-setup-complete ()
    (if (require 'company nil t)
        (opam-setup-add-ocaml-hook
         (lambda ()
           (company-mode)
           (defalias 'auto-complete 'company-complete)))
      (require 'auto-complete nil t)))

  (defun opam-setup-tuareg ()
    (add-to-list 'load-path (concat opam-share "/tuareg") t)
    (load "tuareg-site-file"))

  (defun opam-setup-merlin ()
    ;; (opam-setup-complete)
    (require 'merlin)
    (opam-setup-add-ocaml-hook 'merlin-mode)

    (defcustom ocp-index-use-auto-complete nil
      "Use auto-complete with ocp-index (disabled by default by opam-user-setup because merlin is in use)"
      :group 'ocp_index)
    (defcustom merlin-ac-setup 'easy
      "Use auto-complete with merlin (enabled by default by opam-user-setup)"
      :group 'merlin-ac)

    ;; So you can do it on a mac, where `C-<up>` and `C-<down>` are used
    ;; by spaces.
    (define-key merlin-mode-map
                (kbd "C-c <up>") 'merlin-type-enclosing-go-up)
    (define-key merlin-mode-map
                (kbd "C-c <down>") 'merlin-type-enclosing-go-down)

    (set-face-background 'merlin-type-face "skyblue"))

  (defun opam-setup-ocp-index ()
    (autoload 'ocp-index-mode "ocp-index" "OCaml code browsing, documentation and completion based on build artefacts")
    (opam-setup-add-ocaml-hook 'ocp-index-mode))

  (defun opam-setup-utop ()
    (autoload 'utop "utop" "Toplevel for OCaml" t)
    (autoload 'utop-minor-mode "utop" "Minor mode for utop" t)
    (add-hook 'tuareg-mode-hook 'utop-minor-mode))

  (defun opam-setup-ocamlformat ()
    (load (concat opam-share "/emacs/site-lisp/ocamlformat"))
    (opam-setup-add-ocaml-hook
     (lambda ()
       (define-key tuareg-mode-map (kbd "C-c C-f") #'ocamlformat))))

  (defvar opam-tools
    '(("tuareg" . opam-setup-tuareg)
      ("ocp-index" . opam-setup-ocp-index)
      ("merlin" . opam-setup-merlin)
      ("utop" . opam-setup-utop)
      ("ocamlformat" . opam-setup-ocamlformat)))

  (defun opam-detect-installed-tools ()
    (let*
        ((command "opam list --installed --short --safe --color=never")
         (names (mapcar 'car opam-tools))
         (command-string (mapconcat 'identity (cons command names) " "))
         (reply (opam-shell-command-to-string command-string)))
      (when reply (split-string reply))))

  (defvar opam-tools-installed (opam-detect-installed-tools))

  (defun opam-auto-tools-setup ()
    (interactive)
    (dolist (tool opam-tools)
      (when (member (car tool) opam-tools-installed)
        (funcall (symbol-function (cdr tool))))))

  ;; (opam-auto-tools-setup)
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package tuareg
    :custom
    (tuareg-support-metaocaml t))
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package ocamlformat
    :hook (before-save . ocamlformat-before-save))
#+end_src

#+begin_src emacs-lisp :tangle no
  (add-hook 'before-save-hook 'ocamlformat-before-save)
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package utop
    :config
    ;; Use the opam installed utop
    (setq utop-command "opam exec -- utop -emacs"))
#+end_src

#+begin_src emacs-lisp :tangle no
  ;; OCaml + Make
  (projectile-register-project-type 'ocaml-make '("dune-project" "Makefile")
                                    :project-file "dune-project"
                                    :compile "make -k")
#+end_src

** fstar

#+begin_src emacs-lisp :tangle no
  (use-package fstar-mode)
#+end_src

** Org Mode

#+begin_src emacs-lisp
  ;; 1. Define a face (optional but nice)
  (defface my/org-todo-yellow-bold
    '((t :weight bold :foreground "yellow"))
    "Face for highlighted TODO in org buffers.")

  ;; 2. Define a setup function
  (defun my/org-extra-font-lock ()
    (font-lock-add-keywords
     nil ;; nil = current major mode
     '(("\\bTODO\\b"
        0 'my/org-todo-yellow-bold t))))

  (defun my/org-latex-scale ()
    ;; Start from current options and adjust :scale
    (setq-local org-format-latex-options
                (plist-put org-format-latex-options :scale 1.2))
    ;; If you render a lot, you can reduce dpi; 200 is crisp.
    (setq-local org-format-latex-options
                (plist-put org-format-latex-options :dpi 200)))
#+end_src

#+begin_src emacs-lisp
  (defun org-mode-setup ()
    (org-indent-mode)
    (diminish 'org-indent-mode)
    )

  (defun org-mode-font-setup ()
    ;; Set faces for heading levels
    (dolist (face '((org-level-1 . 1.2)
                    (org-level-2 . 1.1)
                    (org-level-3 . 1.05)
                    (org-level-4 . 1.0)
                    (org-level-5 . 1.1)
                    (org-level-6 . 1.1)
                    (org-level-7 . 1.1)
                    (org-level-8 . 1.1)))
      (set-face-attribute (car face) nil
                          :font "Cantarell" :weight 'regular
                          :height (cdr face))))

  ;; Optional: auto-refresh LaTeX previews after saving (keeps notes pretty)
  ;; 'C-u' to regenerate all fragments
  (defun my/org-refresh-latex-on-save ()
    "Refresh LaTeX previews in the current Org buffer after saving."
    (when (derived-mode-p 'org-mode)
      (org-latex-preview '(16))))
  (add-hook 'after-save-hook #'my/org-refresh-latex-on-save)

  (use-package org
    :hook
    (org-mode . org-mode-setup)
    (org-mode . git-gutter-mode)
    (org-mode . my/org-extra-font-lock)
    (org-mode . my/org-latex-scale)
    :bind (:map org-mode-map
                ("M-n" . org-move-subtree-down)
                ("M-p" . org-move-subtree-up))
    :custom
    (org-directory "~/devel/www-roadmap/org")

    (org-ellipsis " …")
    (org-hide-emphasis-markers t)
    ;; Do not let org split the heading when pressing M-RET
    (org-M-RET-may-split-line'((default . nil)))
    ;; Insert new heading below the existing content if any
    (org-insert-heading-respect-content t)

    (org-src-tab-acts-natively t)

    ;; Show LaTeX fragments inline by default
    (org-startup-with-latex-preview t)
    ;; Use MathJax for HTML exports
    (org-html-with-latex 'mathjax)
    ;; MathJax v3 (fast + compatible)
    (org-html-mathjax-options
     '((path "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js")))
    ;; Better in-buffer preview engine
    (org-preview-latex-default-process 'dvisvgm)

    ;; Agenda:
    (org-agenda-start-with-log-mode t)
    ;; Use current time with completing a task
    (org-log-done 'time)
    ;; Put properties in closed drawer
    (org-log-into-drawer t)
    (org-deadline-warning-days 2)
    ;; Files to be used for agenda display:
    (org-agenda-files (list org-directory))
    (org-agenda-custom-commands
     '(("M" "Monthly view"
        agenda ""
        ((org-agenda-span 'month)
         (org-agenda-start-on-weekday 1)   ;; or 0 for Sunday
         (org-agenda-show-all-dates t)
         (org-deadline-warning-days 7)))))

    ;; Capture templates
    (org-capture-templates
     '(("t" "Task" entry (file "org/inbox.org")
        "* PLAN %?\n%U\n:tags:\n")
       ("p" "Pattern" entry (file "org/patterns.org")
        "* %^{Pattern} :pattern:\nContext:\nProblem:\nSolution:\nExample:\nRefs:\n%U\n")
       ("b" "Blog idea" entry (file "org/blog.org")
        "* %^{Title} :blog:\n#+hugo_section: posts\n#+hugo_tags: [\"pattern\",\"go\",\"ocaml\"]\n#+date: %<%Y-%m-%d>\n\nAngle:\nExample code:\nTakeaway:\n")))

    (org-todo-keywords '((sequence "TODO(t)" "|" "CANCEL(c!)" "DONE(d!)")))

    :config
    (org-mode-font-setup)
    ;; Remove the default underline style from elipsis.
    (set-face-underline 'org-ellipsis nil))

  ;; Replace stars with utf-8 chars.
  (use-package org-bullets
    :hook
    (org-mode . org-bullets-mode)
    :custom
    (org-bullets-bullet-list '("◉" "○" "●" "○" "●" "○" "●")))

  ;; Center text.
  (defun org-mode-visual-fill ()
    (setq visual-fill-column-width 100
          visual-fill-column-center-text t)
    (visual-fill-column-mode 1))
  (use-package visual-fill-column
    :hook
    (org-mode . org-mode-visual-fill)
    (markdown-mode . org-mode-visual-fill))
#+end_src

Allow me to change the size of an image as displayed in Org mode while leaving
the actual file unchanged:

#+begin_src emacs-lisp
  (setq-default org-image-actual-width nil)
#+end_src

** Org Roam

#+begin_src emacs-lisp
  ;; Helper: pull info we inject (citekey & ref) inside templates
  (defun my/ror-citekey ()
    (plist-get org-roam-capture--info :citekey))
#+end_src

#+begin_src emacs-lisp
  (use-package org-roam
    :custom
    (org-roam-directory org-directory)
    (org-roam-completion-everywhere t)

    (org-roam-dailies-capture-templates
     '(("d" "default" entry "* %<%I:%M %p>: %?"
        :if-new (file+head "%<%Y-%m-%d>.org" "#+title: %<%Y-%m-%d>\n"))))

    (org-roam-capture-templates
     `(
       ("d" "Default" plain
        "%?"
        :target (file+head
                 "concepts/%<%Y%m%d%H%M%S>-${slug}.org"
                 "#+title: ${title}\n#+filetags: :concept:\n#+created: %U\n")
        :unnarrowed t)

       ("b" "Book note" plain
        "%?"
        :target (file+head
                 "sources/%(my/ror-citekey)-%<%Y%m%d>-${slug}.org"
                 "#+title: ${title}\n#+filetags: :reading:book:\n#+created: %U\n")
        :unnarrowed t)

       ("c" "Chapter note" plain
        "%?"
        :target (file+head
                 ;; filename includes citekey + a chapter slug
                 "sources/%(my/ror-citekey)-%<%Y%m%d>-${slug}.org"
                 "#+title: ${title}\n#+filetags: :reading:chapter:\n#+created: %U\n")
        :unnarrowed t)
       ))

    :bind (("C-c n i" . org-roam-node-insert)
           ("C-c n f" . org-roam-node-find)
           ("C-c n c" . org-roam-capture)
           ("C-c n b" . org-roam-buffer-toggle)
           ("C-c n g" . org-roam-graph)

           ("C-c b b" . citar-insert-citation)
           ("C-c b r" . citar-insert-reference)
           ("C-c b o" . citar-open-notes)

           ("C-c n a a" . org-roam-alias-add)
           ("C-c n a d" . org-roam-alias-remove)

           ("C-c n t a" . org-roam-tag-add)
           ("C-c n t d" . org-roam-tag-remove)

           ;; Dailies
           ("C-c n d j" . org-roam-dailies-capture-today)
           ("C-c n d y" . org-roam-dailies-capture-yesterday)
           ("C-c n d t" . org-roam-dailies-capture-tomorrow)

           :map org-mode-map
           ("s-i" . completion-at-point))

    :config
    ;; Configure what sections are displayed in the Org-roam buffer:
    (setq org-roam-mode-sections
      (list #'org-roam-backlinks-section
            #'org-roam-reflinks-section
            #'org-roam-unlinked-references-section))

    ;; If you're using a vertical completion framework, you might want
    ;; a more informative completion interface.
    (setq org-roam-node-display-template
          (concat "${title:*} "
                  (propertize "${tags:30}" 'face 'org-tag)))

    ;; Setup Org-roam to run functions on file changes to maintain
    ;; cache consistency:
    (org-roam-db-autosync-mode)

    ;; If using org-roam-protocol
    (require 'org-roam-protocol)

    ;; Org-Roam buffer display as a regular window on the side
    (add-to-list 'display-buffer-alist
             '("\\*org-roam\\*"
               (display-buffer-in-direction)
               (direction . right)
               (window-width . 0.33)
               (window-height . fit-window-to-buffer))))
#+end_src

#+begin_src emacs-lisp
  (use-package consult-org-roam
   :after org-roam
   :init
   (require 'consult-org-roam)
   ;; Activate the minor mode
   (consult-org-roam-mode 1)
   :custom
   ;; Use `ripgrep' for searching with `consult-org-roam-search'
   (consult-org-roam-grep-func #'consult-ripgrep)
   ;; Configure a custom narrow key for `consult-buffer'
   (consult-org-roam-buffer-narrow-key ?r)
   ;; Display org-roam buffers right after non-org-roam buffers
   ;; in consult-buffer (and not down at the bottom)
   (consult-org-roam-buffer-after-buffers t)
   :config
   ;; Eventually suppress previewing for certain functions
   (consult-customize
    consult-org-roam-forward-links
    :preview-key "M-.")
   :bind
   ;; Define some convenient keybindings as an addition
   ("C-c n e" . consult-org-roam-file-find)
   ("C-c n b" . consult-org-roam-backlinks)
   ("C-c n B" . consult-org-roam-backlinks-recursive)
   ("C-c n l" . consult-org-roam-forward-links)
   ("C-c n r" . consult-org-roam-search))
#+end_src

*** Citar

#+begin_src emacs-lisp
  (use-package citar
    :custom
    ;; Global bibliography
    (citar-bibliography '("~/devel/www-roadmap/bib/refs.bib"))
    (citar-org-roam-subdir "lit")

    ;; Org-cite
    (org-cite-global-bibliography citar-bibliography)
    (org-cite-insert-processor 'citar)
    (org-cite-follow-processor 'citar)
    (org-cite-activate-processor 'citar))
#+end_src

#+begin_src emacs-lisp
  (use-package citar-org-roam
    :after (org-roam citar)
    :config
    (citar-org-roam-mode))
#+end_src

#+begin_src emacs-lisp
  (defun my/citar-roam--pick-citekey ()
    "Pick one citekey via citar and return it as a string."
    (citar-select-ref))

  (defun my/citar-roam-capture-book ()
    "Create a *book-level* Org-roam note for a chosen reference."
    (interactive)
    (let* ((ck (my/citar-roam--pick-citekey))
           (ref (format "@%s" ck))
           ;; Nice title from the bib entry via citar's formatter:
           (title (citar-format--entry "${author editor} (${year}). ${title}" (citar-get-entry ck))))
      (org-roam-capture-
       :templates org-roam-capture-templates
       :node (org-roam-node-create :title title)
       :props '(:finalize find-file)
       :info (list :citekey ck)
       :keys "b")
      (org-roam-ref-add ref)))

  (defun my/citar-roam-capture-chapter ()
    "Create a *chapter-level* Org-roam note (separate file) for a chosen reference."
    (interactive)
    (let* ((ck (my/citar-roam--pick-citekey))
           (ref (format "@%s" ck))
           (book-title (citar-format--entry
                        "${author editor} (${year}). ${title}"
                        (citar-get-entry ck)))
           (chap-label (read-string "Chapter: "))
           (node-title (format "%s - %s" book-title chap-label)))
      (org-roam-capture-
       :templates org-roam-capture-templates
       :node (org-roam-node-create :title node-title)
       :props '(:finalize find-file)
       :info (list :citekey ck)
       :keys "c")
      (org-roam-ref-add ref)))
#+end_src

I prefer ~citar-org-roam~:
#+begin_src emacs-lisp :tangle no
  (use-package org-roam-bibtex
    :after (org-roam citar)
    :commands (orb-note-actions)
    :custom (orb-roam-ref-format 'citekey))
#+end_src

*** Deft

#+begin_src emacs-lisp :tangle no
  (use-package deft
    :after org-roam
    :bind
    ;("C-c d" . deft)
    :custom
    (deft-recursive t)
    (deft-use-filename-as-title nil)
    (deft-use-filter-string-for-filename t)
    (deft-file-naming-rules '((noslash . "-")
                              (nospace . "-")
                              (case-fn . downcase)))
    (deft-text-mode 'org-mode)
    (deft-default-extension "org")
    (deft-directory org-roam-directory)
    (deft-auto-save-interval 300))
#+end_src

*** Flyspell

#+begin_src emacs-lisp :tangle no
  (use-package flyspell)
#+end_src

** Latex

#+begin_src emacs-lisp :tangle no
  (use-package tex
    :straight auctex)
#+end_src

** Babel

#+begin_src emacs-lisp
  ;; Evalute Babel code without asking for confirmation.
  (set 'org-confirm-babel-evaluate nil)

  ;; Package org-tempo allows me to create Babel blocks with
  ;; templates starting with "<".
  (require 'org-tempo)
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("ocaml" . "src ocaml"))
  (add-to-list 'org-structure-template-alist '("bash" . "src bash"))
  (add-to-list 'org-structure-template-alist '("js" . "src js"))
  (add-to-list 'org-structure-template-alist '("json" . "src json"))

  ;; Enable Babel languages.
  (org-babel-do-load-languages
   'org-babel-load-languages '((ocaml . t)
                               (emacs-lisp . t)
                               (latex . t)
                               (js . t)))
#+end_src

** Standard ML

#+begin_src emacs-lisp :tangle no
  (use-package sml-mode)
#+end_src

** PDF

#+begin_src emacs-lisp
  (use-package pdf-tools
    :mode
    (("\\.pdf$" . pdf-view-mode))

    :custom
    ;; pdf-annot-activate-created-annotations t ;; automatically annotate highlights
    pdf-view-resize-factor 1.1 ;; 10%

    :bind
    (:map pdf-view-mode-map
          ;; normal isearch
          ("C-s" . isearch-forward)
          ;; custom keys
          ("h" . pdf-annot-add-highlight-markup-annotation)
          ("t" . pdf-annot-add-text-annotation)
          ("D" . pdf-annot-delete))

    :hook
    ((pdf-view-mode) . (lambda () (cua-mode 0)))

    :config
    (pdf-tools-install)
    (setq-default pdf-view-display-size 'fit-page)
    (setq-default pdf-annot-color-history
                  '("plum" "dark khaki" "coral" "cyan" "gold"
         		  (highlight (color . "gold")) (underline (color . "blue"))
         		  (squiggly (color . "orange")) (strike-out (color . "red"))))
    (setq-default pdf-annot-default-annotation-properties
                  '((t
                     (label . ""))
                    (text
                     (color . "#ff0000")
                     (icon . "Note"))
                    (highlight
                     (color . "gold"))
                    (underline
                     (color . "blue"))
                    (squiggly
                     (color . "orange"))
                    (strike-out
                     (color . "red"))))
    (customize-set-variable
     'display-buffer-alist
     '(("^\\*outline"
        display-buffer-in-side-window
        (side . right)
        (window-width . 0.35)
        (inhibit-switch-frame . t)))))
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package org-pdftools
    :after org
    :hook (org-load . org-pdftools-setup-link))

  ;; Optional: quickly extract highlights into Org
  (use-package org-noter-pdftools
    :after (org-noter pdf-tools)
    :config
    (with-eval-after-load 'pdf-annot
      (setq pdf-annot-activate-created-annotations t)))
#+end_src

#+begin_src emacs-lisp
;; (use-package pdf-tools
;;   ;; :pin manual ;; manually update
;;   :config
;;   ;; initialise
;;   (pdf-tools-install)
;;   ;; open pdfs scaled to fit page
;;   (setq-default pdf-view-display-size 'fit-page)
;;   ;; automatically annotate highlights
;;   ;; (setq pdf-annot-activate-created-annotations t)
;;   ;; use normal isearch
;;   (define-key pdf-view-mode-map (kbd "C-s") 'isearch-forward)
;;   ;; turn off cua so copy works
;;   (add-hook 'pdf-view-mode-hook (lambda () (cua-mode 0)))
;;   ;; more fine-grained zooming
;;   (setq pdf-view-resize-factor 1.1)
;;   ;; keyboard shortcuts
;;   (define-key pdf-view-mode-map (kbd "h") 'pdf-annot-add-highlight-markup-annotation)
;;   (define-key pdf-view-mode-map (kbd "t") 'pdf-annot-add-text-annotation)
;;   (define-key pdf-view-mode-map (kbd "D") 'pdf-annot-delete))
#+end_src

#+begin_src emacs-lisp
  ;; (pdf-tools-install)
  ;; (setq pdf-annot-default-annotation-properties
  ;;       '((highlight
  ;;          (color . "gold"))
  ;;         (underline
  ;;          (color . "blue"))
  ;;         (squiggly
  ;;          (color . "orange"))
  ;;         (strike-out
  ;;          (color . "red"))))
#+end_src

** Scheme

#+begin_src emacs-lisp :tangle no
  (use-package geiser)
  (use-package geiser-guile)
#+end_src

** Rust

#+begin_src emacs-lisp :tangle no
  (use-package rust-mode
    :config
    ; Force indentation to use spaces.
    (indent-tabs-mode nil)
    (rust-enable-format-on-save)
    (prettify-symbols-mode))
#+end_src

** JSON

#+begin_src emacs-lisp :tangle no
  (use-package json-mode)
#+end_src

** Go

#+begin_src emacs-lisp
  (use-package go-mode
    :hook (before-save . gofmt-before-save))
#+end_src

** Idris

#+begin_src emacs-lisp :tangle no
  (use-package idris-mode
    :custom
    (idris-interpreter-path "idris2"))

  ;; (use-package idris-mode
  ;;   :mode ("\\.l?idr\\'" . idris-mode)
  ;;   :config
  ;;   (after lsp-mode
  ;;     (add-to-list 'lsp-language-id-configuration '(idris-mode . "idris2"))
  ;;     (lsp-register-client
  ;;      (make-lsp-client
  ;;       :new-connection (lsp-stdio-connection "idris2-lsp")
  ;;       :major-modes '(idris-mode)
  ;;       :server-id 'idris2-lsp))
  ;;     )
  ;;     ;; (setq lsp-semantic-tokens-enable t) ;; Optionally enable semantic tokens
  ;;   (add-hook 'idris-mode-hook #'lsp!)

#+end_src

** LLVM

Syntax highlighting mode for LLVM assembly files:
#+begin_src emacs-lisp
  (setq load-path (cons (expand-file-name "~/devel/llvm-project/llvm/utils/emacs/") load-path))
  (require 'llvm-mode) ;; Enables automatically in files ending in .ll
#+end_src

The following =clang-format= configuration expects a =.clang-format= file that can
be generated with: ~$ clang-format -style=llvm -dump-config > .clang-format~

#+begin_src emacs-lisp
  (use-package clang-format
    :hook
    (c-mode . clang-format-on-save-mode))
#+end_src

** C

#+begin_src emacs-lisp :tangle no
  ;; Frama C
  (setq load-path (cons (expand-file-name "~/.opam/5.3.0/share/frama-c/share/emacs/") load-path))
  (autoload 'acsl-mode "acsl" "Major mode for editing ACSL code" t)
  (add-to-list 'lsp-language-id-configuration '(acsl-mode . "c"))
#+end_src

#+begin_src emacs-lisp
  (use-package disaster
    :custom
    (disaster-objdump "objdump --disassemble --source --line-numbers --no-show-raw-insn")
    (disaster-project-root-files '((".git"))))
#+end_src

* Terminals

We use vterm with defaults for the momment.

#+begin_src emacs-lisp :tangle no
;; (use-package vterm)
#+end_src

* Dired

In dired, we bind some shortcuts and change the default sorting of files and
dirs.

#+begin_src emacs-lisp
  (use-package dired
    :straight nil ; Built-in
    :commands (dired dired-jump)
    :bind (
           ("C-x C-j" . dired-jump))
    :custom
    (delete-by-moving-to-trash t)
    (trash-directory "~/trash/")
    (file-name-shadow-mode t)
    (dired-listing-switches "-ltgo")
    :hook
    (dired-mode-hook . dired-hide-details-mode))
#+end_src

* Publishing

#+begin_src emacs-lisp
  (use-package ox-hugo :after ox)
  (use-package markdown-mode)
#+end_src
