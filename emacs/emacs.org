#+title Emacs Configuration
#+PROPERTY: header-args:emacs-lisp :tangle ~/.emacs.d/init.el

* Globals

#+begin_src emacs-lisp
  (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
  (load custom-file)
#+end_src

Set some global default values. We use only =setq-default= in case a
configuration is "buffer local".

#+begin_src emacs-lisp
  (setq-default
   inhibit-startup-message t

   ;; Keep point at the same screen position when scrolling up and down pages.
   scroll-preserve-screen-position t

   ;; Regardless of whether auto-fill is enabled, we always have 80 columns.
   fill-column 80

   visible-bell t

   ;; Put all backup files here (those that end on a ~).
   backup-directory-alist '(("" . "~/.emacs.d/backup"))

   ;; Smoother scrolling from
   ;; https://www.emacswiki.org/emacs/SmoothScrolling
   scroll-step 1
   scroll-conservatively 10000
   ;; In number of lines
   scroll-margin 20

   ;; Instruct auto-save-mode to save to the current file, not a backup file
   auto-save-default nil

   ;; No backup files, please
   make-backup-files nil

   ;; Make it easy to cycle through previous items in the mark ring
   set-mark-command-repeat-pop t

   ;; Don't warn on large files
   large-file-warning-threshold nil

   ;; Don't warn on advice
   ad-redefinition-action 'accept

   ;; Revert Dired and other buffers
   global-auto-revert-non-file-buffers t

   ;; Silence compiler warnings as they can be pretty disruptive
   native-comp-async-report-warnings-errors nil

   ;; Indentation cannot insert tabs
   indent-tabs-mode nil
   tab-width 2

   ;; One can instruct Emacs to always resolve symlinks, at a performance cost
   find-file-visit-truename t

   ;; Tell global-auto-revert-mode to act also on Dired buffers
   global-auto-revert-non-file-buffers t)
#+end_src

Personal key maps:

#+begin_src emacs-lisp
  (defvar-keymap my-other-map)
  (keymap-set global-map "C-o" my-other-map)

  (defvar-keymap my-search-map)
  (keymap-set global-map "C-s" my-search-map)

  (defvar-keymap my-toggle-map
    "l" 'display-line-numbers-mode)
  (keymap-set global-map "C-t" my-toggle-map)
#+end_src

By default, we must hit escape three times to quit anything. Make it only once:

#+begin_src emacs-lisp
  (global-set-key (kbd "<escape>") 'keyboard-escape-quit)
#+end_src

Some global hooks:

#+begin_src emacs-lisp
  ;; In all modes, delete trailing whitespaces before saving.
  (add-hook 'before-save-hook #'delete-trailing-whitespace)
#+end_src

* Package management

Configure package repositories:
/(Not needed since we are using =straight.el= for package management)/

#+begin_src emacs-lisp :tangle no
  (require 'package)
  (setq package-archives '(("melpa" . "https://melpa.org/packages/")
                           ("org" . "https://orgmode.org/elpa/")
                           ("elpa" . "https://elpa.gnu.org/packages/")))
  (package-initialize)
#+end_src

Install the =straight.el= package manager:

#+begin_src emacs-lisp
  (defvar bootstrap-version)
  (let ((bootstrap-file
  	 (expand-file-name
  	  "straight/repos/straight.el/bootstrap.el"
  	  (or (bound-and-true-p straight-base-dir)
  	      user-emacs-directory)))
  	(bootstrap-version 7))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
  	  (url-retrieve-synchronously
  	   "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
  	   'silent 'inhibit-cookies)
  	(goto-char (point-max))
  	(eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
#+end_src

Install =use-package= via =straight.el=:

#+begin_src emacs-lisp
  ;; Integrate straight.el with use-package
  (straight-use-package '(use-package :host github :repo "emacs-straight/use-package"))
#+end_src

Tell =straight.el= to ensure all my packages are installed by default:

#+begin_src emacs-lisp
  ;; Add :straight t to all my packages so they are installed by default
  (setq straight-use-package-by-default t)
#+end_src

Together with use-package, =:diminish= can hide minor modes from the mode line.

#+begin_src emacs-lisp
  ;; Add :diminish to keep minor modes out of the mode line.
  (use-package diminish
    :demand t)
#+end_src

* Built-in global modes

Global modes that come installed with Emacs:

#+begin_src emacs-lisp
  ;; Enable repeating key maps
  (repeat-mode t)

  ;; Hide the menu bar
  (menu-bar-mode 0)

  ;; Hide the tool bar
  (tool-bar-mode 0)

  ;; Hide the scroll bar
  (scroll-bar-mode 0)

  ;; Enable mouse events in terminal Emacs
  (xterm-mouse-mode t)

  ;; Display time in mode line / tab bar
  (display-time-mode t)

  ;; Improved vertical minibuffer completions
  (fido-vertical-mode 0)

  ;; Show column number on mode line
  (column-number-mode t)

  ;; Remember previous tab window configurations
  (tab-bar-history-mode t)

  ;; Auto-save files at an interval
  (auto-save-visited-mode t)

  ;; Visually wrap long lines in all buffers
  (global-visual-line-mode t)

  ;; Refresh buffers with changed local files
  (global-auto-revert-mode t)

  ;; To navigate window configuration history
  (winner-mode t)

  ;; When this global minor mode is enabled, Emacs displays help
  ;; text (e.g. for buttons and menu items that you put the mouse on)
  ;; in a pop-up window.
  (tooltip-mode t)

  ;; Disable line numbers on the left by default
  (global-display-line-numbers-mode 0)

  ;; Show column number at the bottom next to the line number.
  (column-number-mode t)

  ;; Refresh buffers automatically.
  (global-auto-revert-mode t)

  ;; Save place in each file.
  (save-place-mode t)

  ;; Break lines at right margin.
  (auto-fill-mode t)
#+end_src

#+begin_src emacs-lisp
  (use-package imenu
    :straight nil ; Built-in
    :demand t
    :custom
    ; Always rescan the buffers (also recommended by Treemacs)
    (imenu-auto-rescan t))
#+end_src

From =recentf-mode=:
  By default, only operations like opening a file, writing a buffer
  to a file, and killing a buffer is counted as "operating" on
  the file.  If instead you want to prioritize files that appear in
  buffers you switch to a lot, you can say something like the following:

#+begin_src emacs-lisp
  (use-package recentf
    :straight nil ; Built-in
    :demand t
    :config
    (recentf-mode t)
    (add-hook 'buffer-list-update-hook #'recentf-track-opened-file))
#+end_src

#+begin_src emacs-lisp
  ;; Persist history over Emacs restarts
  ;; Vertico sorts by history position
  (use-package savehist
    :straight nil ; Built-in
    :demand t
    :custom
    (savehist-save-minibuffer-history t)
    :config
    (savehist-mode t)

    ;; Variables here must be printable with the Lisp printer.
    ;; Seems like ones defined in C cannot be saved.
    (add-to-list 'savehist-additional-variables  'compile-command)
    (add-to-list 'savehist-additional-variables  'command-history)
    (add-to-list 'savehist-additional-variables  'kill-ring))
#+end_src

* Global modes

Global modes that do not come with Emacs.

#+begin_src emacs-lisp
  ;; Helps visualise colors when editing themes and such
  (use-package rainbow-mode)
#+end_src

#+begin_src emacs-lisp
  (use-package keycast
    :demand t ; Demand because we bind keys below and want them always available
    :custom
    (keycast-mode-line-insert-after 'mode-line-buffer-identification)
    (keycast-mode-line-remove-tail-elements nil)
    :bind (
           :map my-toggle-map
                ("k" . keycast-mode-line-mode)))
#+end_src

#+begin_src emacs-lisp
  (use-package which-key
    :demand t
    :diminish
    :config
    (which-key-mode t))
#+end_src

#+begin_src emacs-lisp :tangle no
  (setq load-path (cons (expand-file-name "~/devel/ott/emacs") load-path))
  (require 'ott-mode)
#+end_src

#+begin_src emacs-lisp :tangle no
  (load "~/devel/HOL/tools/hol-mode")
  (load "~/devel/HOL/tools/hol-unicode")
#+end_src

#+begin_src emacs-lisp
  (use-package yasnippet
    :demand t
    :diminish yas-minor-mode
    :config
    (yas-global-mode t))

  (use-package yasnippet-snippets
    :diminish
    :after yasnippet)
#+end_src

When there are two windows, =ace-window= will call other-window (unless
aw-dispatch-always is set non-nil). If there are more, each window will have the
first character of its window label highlighted at the upper left of the window.

#+begin_src emacs-lisp
  (use-package ace-window
    :demand t
    :bind
    ("M-o" . #'ace-window))
#+end_src

[[https://github.com/DevelopmentCool2449/colorful-mode][Colorful Mode]] helps to visualise colors:

#+begin_src emacs-lisp
  (use-package colorful-mode
    :custom
    (colorful-use-prefix t)
    (colorful-only-strings 'only-prog)
    (css-fontify-colors nil)
    :config
    (add-to-list 'colorful-extra-color-keyword-functions
                 ;; Work with color names in Org
                 '(org-mode . (colorful-add-color-names)))
    :hook
    (org-mode . colorful-mode))
#+end_src

* Theme

#+begin_src emacs-lisp
  (load-theme 'wombat t) ;; t is for "safe"

  (custom-set-faces
   '(highlight ((t (:inherit region :background "#556b2f"))))
   '(hl-line ((t (:inherit highlight))))
   '(line-number ((t (:inherit (shadow default) :background "#2e2e2e")))))
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package modus-themes
    :demand t
    :config
    ;; Add all your customizations prior to loading the themes
    ;;(setq modus-themes-italic-constructs t
    ;;      modus-themes-bold-constructs nil)

    ;; Maybe define some palette overrides, such as by using our presets
    ;; (setq modus-themes-common-palette-overrides
    ;;      modus-themes-preset-overrides-intense)

    ;; Load the theme of your choice.
    (modus-themes-load-theme 'modus-operandi-tinted)

    ;; We have a key mapping to toggle between dark and light themes
    (setq modus-themes-to-toggle '(modus-operandi-tinted modus-vivendi))

    (define-key global-map (kbd "<f5>") #'modus-themes-rotate))

  (set-fringe-style 20) ; Set a fringe on left and right (in pixels)
#+end_src

Mode line:

Original, just for reference:

#+begin_src emacs-lisp :tangle no
  (setq-default mode-line-format '("%e" mode-line-front-space
                                   (:propertize
                                    ("" mode-line-mule-info mode-line-client mode-line-modified mode-line-remote
                                     mode-line-window-dedicated)
                                    display (min-width (6.0)))
                                   mode-line-frame-identification mode-line-buffer-identification "   "
                                   mode-line-position (project-mode-line project-mode-line-format)
                                   (vc-mode vc-mode) "  " mode-line-modes mode-line-misc-info mode-line-end-spaces))
#+end_src

Ours:

#+begin_src emacs-lisp
  (setq-default mode-line-format
                '("%e" mode-line-front-space

                  (:propertize
                   ("" mode-line-modified mode-line-window-dedicated)
                   display (min-width (6.0)))

                  mode-line-frame-identification mode-line-buffer-identification
                  "   "
                  mode-line-position (project-mode-line project-mode-line-format)
                  (vc-mode vc-mode)
                  "   "
                  mode-line-modes))
#+end_src

* Keyboard shortcuts

#+begin_src emacs-lisp
  (global-set-key (kbd "C-v") 'scroll-down-command)
  (global-set-key (kbd "M-v") 'scroll-up-command)
#+end_src

The following is now replaced by =ace-window=:

#+begin_src emacs-lisp :tangle no
  ;; Shortcut to switch between two buffers.
  (global-set-key (kbd "M-o")  'mode-line-other-buffer)
#+end_src

Allow movement between windows using SHIFT plus arrow:

#+begin_src emacs-lisp :tangle no
  (windmove-default-keybindings)
#+end_src

* Emacs Configuration

Auto-tangle configuration files when we save this org file.

#+begin_src emacs-lisp
  ;; Automatically tangle our emacs.org config file when we save it.
  (defun org-babel-tangle-config ()
    (when (string-equal (buffer-file-name)
                        (expand-file-name "~/devel/dotfiles/emacs/emacs.org"))
      (let ((org-confirm-babel-evaluate nil))
        (org-babel-tangle))))

  (add-hook 'org-mode-hook (lambda ()
                             (add-hook 'after-save-hook
                                       'org-babel-tangle-config)))
#+end_src

Here is a function that we can bind to a keybinding. It reloads our =~/.emacs=.

#+begin_src emacs-lisp
  (defun reload-dotemacs ()
    (interactive)
    (load-file "~/.emacs.d/init.el"))

  ;; Reload our ~/.emacs.
  (global-set-key (kbd "C-c <f12>") #'reload-dotemacs)
#+end_src

* Completion

Company for in-buffer completion.

#+begin_src emacs-lisp
  (use-package company
    :config
    (global-company-mode t))
#+end_src

* Minibuffer completion
** Ivy (disabled)

Ivy is disabled at the moment in favour of Vertico.

#+begin_src emacs-lisp :tangle no
  (use-package ivy
    :disabled
    :diminish
    :bind (("C-s" . swiper)
           ("C-x b" . ivy-switch-buffer)
           ("C-x C-b" . ivy-switch-buffer))
    :config
    ;; Always enabled.
    (ivy-mode 1)
    :init
    ;; Add files and bookmarks to switch-buffer prompt.
    (setq ivy-use-virtual-buffers t)
    (setq ivy-count-format "(%d/%d) "))

  ;; Prescient to sort auto-completion by recency.
  (use-package ivy-prescient
    :disabled
    :diminish
    :config
    (ivy-prescient-mode 1))
#+end_src

** Vertico and friends

#+begin_src emacs-lisp
  (use-package vertico
    :demand t
    :hook
    ;; Works with =file-name-shadow-mode= enabled.
    (rfn-eshadow-update-overlay . vertico-directory-tidy)
    :config
    (vertico-mode t))
#+end_src

Marginalia for annotations in the minibuffer.

#+begin_src emacs-lisp
  (use-package marginalia
    :demand t
    :config
    (marginalia-mode t))
#+end_src

Consult provides search and navigation commands.

#+begin_src emacs-lisp
  (use-package consult
    :demand t
    :hook
    ;; Enable automatic preview at point in the *Completions* buffer.
    (completion-list-mode . consult-preview-at-point-mode)
    :bind (("C-y" . consult-yank-from-kill-ring)
           :map my-search-map
           ("l" . consult-line)             ; Search (l)ine in current buffer
           ("L" . consult-line-multi)       ; Seach across project buffers
           ("i" . consult-imenu)            ; Seach imenu (i)tems
           ("f" . consult-find)             ; Find file in project
           ("b" . consult-buffer)           ; Find a buffer
           ("m" . consult-kmacro)           ; Find a keyboard macro
           ("B" . consult-project-buffer)
           ("o" . consult-outline)
           ("e" . consult-compile-error)
           :map my-other-map
           ("b" . consult-buffer-other-window)))
#+end_src

Orderless allows me to search word parts in any order.

#+begin_src emacs-lisp
  (use-package orderless
    :demand t
    :init
    ;; Configure a custom style dispatcher (see the Consult wiki)
    ;; (setq orderless-style-dispatchers '(+orderless-consult-dispatch orderless-affix-dispatch)
    ;;       orderless-component-separator #'orderless-escapable-split-on-space)
    (setq completion-styles '(orderless basic)
          completion-category-defaults nil
          completion-category-overrides '((file (styles partial-completion)))))
#+end_src

* Projects

#+begin_src emacs-lisp
  (use-package projectile
    :demand t
    :diminish projectile-mode
    :bind (
           :map projectile-mode-map
  	            ("C-c p" . projectile-command-map))
    :init
    (when (file-directory-p "~/devel")
      (setq projectile-project-search-path '("~/devel")))
    :config
    (projectile-mode t)
    ;; Open project in dired by default
    (setq projectile-switch-project-action 'projectile-dired))
#+end_src

Disable =counsel-projectile= if using Vertico + Consult instead of Ivy.

#+begin_src emacs-lisp :tangle no
  (use-package counsel-projectile
    :disabled
    :after projectile
    :config
    (counsel-projectile-mode))
#+end_src

#+begin_src emacs-lisp
  (use-package editorconfig
    :demand t
    :diminish
    :config
    (editorconfig-mode t))
#+end_src

* Search

#+begin_src emacs-lisp :tangle no
  (use-package ripgrep)
#+end_src

* Language Server Protocol (LSP)

Vanilla =lsp-mode=:

#+begin_src emacs-lisp
  (use-package lsp-mode
    :commands (lsp lsp-deferred)

    :init
    (setq lsp-keymap-prefix "C-c l")  ;; Or 'C-l', 's-l'

    :config
    (lsp-enable-which-key-integration t)

    :hook (;; Enable languages here:
           (c-mode . lsp-deferred)
           (tuareg-mode . lsp-deferred)
           (shell-script-mode . lsp-deferred)))
#+end_src

Optional packages to support =lsp-mode=:

#+begin_src emacs-lisp
  (use-package lsp-ui
    :commands lsp-ui-mode)
#+end_src

#+begin_src emacs-lisp
  (use-package flycheck
    :hook
    (lsp-mode . flycheck-mode))
#+end_src

* Treemacs

[[https://github.com/Alexander-Miller/treemacs][Treemacs]] - a tree layout file explorer for Emacs:
#+begin_src emacs-lisp
  (use-package treemacs
    :config
    (treemacs-follow-mode 0)
    (setq treemacs-space-between-root-nodes nil)
    :bind (
           ("M-0"       . treemacs-select-window)
           ("C-x t 1"   . treemacs-delete-other-windows)
           ("C-x t t"   . treemacs)
           ("C-x t d"   . treemacs-select-directory)
           ("C-x t B"   . treemacs-bookmark)
           ("C-x t C-t" . treemacs-find-file)
           ("C-x t M-t" . treemacs-find-tag))
    :demand t)
#+end_src

Optionals:

#+begin_src emacs-lisp
  ;; Allows treemacs icons in dired buffers.
  (use-package treemacs-icons-dired
    :demand t
    :after dired
    :hook
    (dired-mode . treemacs-icons-dired-enable-once))

  ;; Integration between lsp-mode and treemacs
  (use-package lsp-treemacs
    :after (treemacs lsp))

  ;; Allows to quickly add your projectile projects to the treemacs workspace.
  (use-package treemacs-projectile
    :after (treemacs projectile))

  ;; It will inform treemacs about (un)staging of files and commits happening in magit.
  (use-package treemacs-magit
    :after (treemacs magit))
#+end_src

* Tree Sitter

Configure some ~tree-sitter~ grammars locations:

#+begin_src emacs-lisp :tangle no
  (setq treesit-language-source-alist
     '((bash "https://github.com/tree-sitter/tree-sitter-bash")
       (cmake "https://github.com/uyha/tree-sitter-cmake")
       (css "https://github.com/tree-sitter/tree-sitter-css")
       (elisp "https://github.com/Wilfred/tree-sitter-elisp")
       (go "https://github.com/tree-sitter/tree-sitter-go")
       (html "https://github.com/tree-sitter/tree-sitter-html")
       (javascript "https://github.com/tree-sitter/tree-sitter-javascript" "master" "src")
       (json "https://github.com/tree-sitter/tree-sitter-json")
       (make "https://github.com/alemuller/tree-sitter-make")
       (markdown "https://github.com/ikatyang/tree-sitter-markdown")
       (python "https://github.com/tree-sitter/tree-sitter-python")
       (toml "https://github.com/tree-sitter/tree-sitter-toml")
       (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
       (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
       (yaml "https://github.com/ikatyang/tree-sitter-yaml")
       (c "https://github.com/tree-sitter/tree-sitter-c")))
#+end_src

* Compilation

Configurations for the compilation buffer:

#+begin_src emacs-lisp
  (setq-default next-error-message-highlight t)
  (setq-default compilation-window-height 20)
#+end_src

* Programming Environments
** Git

#+begin_src emacs-lisp
  ;; https://github.com/emacsorphanage/git-gutter
  (use-package git-gutter
    :diminish
    :hook
    ;; Enable in all modes that inherit from prog-mode.
    (prog-mode . git-gutter-mode)
    (org-mode . git-gutter-mode)
    :config
    ;; Interval in seconds.
    (setq git-gutter:update-interval 1))

  ;; https://github.com/emacsorphanage/git-gutter-fringe
  (use-package git-gutter-fringe
    :config
    ;; Green
    (define-fringe-bitmap 'git-gutter-fr:added [224] nil nil '(center repeated))
    ;; Purple
    (define-fringe-bitmap 'git-gutter-fr:modified [224] nil nil '(center repeated))
    ;; Red
    (define-fringe-bitmap 'git-gutter-fr:deleted [128 192 224 240] nil nil 'bottom))

  (use-package magit
    :custom
    ; By default, Magit opens status in a new window.
    (magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1))
#+end_src

** Lisp

#+begin_src emacs-lisp
  ;; We enable eldoc only for Lisp
  (use-package eldoc
    :straight nil ; Built-in
    :hook
    (emacs-lisp-mode . eldoc-mode)
    (lisp-mode . eldoc-mode)
    (lisp-interaction-mode . eldoc-mode)
    :config
    (global-eldoc-mode 0))
#+end_src

#+begin_src emacs-lisp
  (use-package paredit
    :hook
    (emacs-lisp-mode . eldoc-mode)
    (lisp-mode . paredit-mode)
    (lisp-interaction-mode . paredit-mode))

  (use-package rainbow-delimiters
    :config
    ;; Set faces for error and levels
    (dolist (face '((rainbow-delimiters-base-error-face . "magenta")
                    (rainbow-delimiters-depth-1-face    . "gold")
                    (rainbow-delimiters-depth-2-face    . "spring green")
                    (rainbow-delimiters-depth-3-face    . "dark salmon")
                    (rainbow-delimiters-depth-4-face    . "tomato")
                    (rainbow-delimiters-depth-5-face    . "hot pink")
                    (rainbow-delimiters-depth-6-face    . "peach puff")))
      (set-face-attribute (car face) nil
                          :foreground (cdr face)))

    :bind (:map my-toggle-map
                ("r" . rainbow-delimiters-mode))

    :hook
    (emacs-lisp-mode . eldoc-mode)
    (lisp-mode . rainbow-delimiters-mode)
    (lisp-interaction-mode . rainbow-delimiters-mode))
#+end_src

** OCaml

#+begin_src emacs-lisp :tangle no
  (use-package tuareg)
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package ocamlformat
    :hook (before-save . ocamlformat-before-save))
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package utop
    :config
    ;; Use the opam installed utop
    (setq utop-command "opam exec -- utop -emacs"))
#+end_src

#+begin_src emacs-lisp :tangle no
  ;; OCaml + Make
  (projectile-register-project-type 'ocaml-make '("dune-project" "Makefile")
                                    :project-file "dune-project"
                                    :compile "make -k")
#+end_src

** fstar

#+begin_src emacs-lisp :tangle no
  (use-package fstar-mode)
#+end_src

** Org Mode

#+begin_src emacs-lisp
  (defun org-mode-setup ()
    (org-indent-mode)
    (diminish 'org-indent-mode))

  (defun org-mode-font-setup ()
    ;; Set faces for heading levels
    (dolist (face '((org-level-1 . 1.2)
                    (org-level-2 . 1.1)
                    (org-level-3 . 1.05)
                    (org-level-4 . 1.0)
                    (org-level-5 . 1.1)
                    (org-level-6 . 1.1)
                    (org-level-7 . 1.1)
                    (org-level-8 . 1.1)))
      (set-face-attribute (car face) nil
                          :font "Cantarell" :weight 'regular
                          :height (cdr face))))

  (use-package org
    :straight nil ; Built-in
    :hook
    (org-mode . org-mode-setup)
    (org-mode . git-gutter-mode)
    :bind (:map org-mode-map
                ("M-n" . org-move-subtree-down)
                ("M-p" . org-move-subtree-up))
    :custom
    (org-ellipsis " …")
    (org-hide-emphasis-markers t)
    ;; Use the language's major-mode binding in code blocks
    (org-src-tab-acts-natively t)
    ;; Do not let org split the heading when pressing M-RET
    (org-M-RET-may-split-line'((default . nil)))
    ;; Insert new heading below the existing content if any
    (org-insert-heading-respect-content t)

    ;; Agenda:
    (org-agenda-start-with-log-mode t)
    ;; Use current time with completing a task
    (org-log-done 'time)
    ;; Put properties in closed drawer
    (org-log-into-drawer t)
    (org-directory "~/devel/org-mode-my-files")
    (org-deadline-warning-days 2)
    ;; Files to be used for agenda display:
    (org-agenda-files (list org-directory))

    (org-todo-keywords '((sequence "TODO(t)" "|" "CANCEL(c!)" "DONE(d!)")))

    :config
    (org-mode-font-setup)
    ;; Remove the default underline style from elipsis.
    (set-face-underline 'org-ellipsis nil))

  ;; Replace stars with utf-8 chars.
  (use-package org-bullets
    :hook
    (org-mode . org-bullets-mode)
    :custom
    (org-bullets-bullet-list '("◉" "○" "●" "○" "●" "○" "●")))

  (defun org-mode-visual-fill ()
    (setq visual-fill-column-width 100
          visual-fill-column-center-text t)
    (visual-fill-column-mode 1))

  ;; Center text.
  (use-package visual-fill-column
    :hook
    (org-mode . org-mode-visual-fill)
    (markdown-mode . org-mode-visual-fill))
#+end_src

Allow me to change the size of an image as displayed in Org mode while leaving
the actual file unchanged:

#+begin_src emacs-lisp
  (setq-default org-image-actual-width nil)
#+end_src

** Org Roam

#+begin_src emacs-lisp :tangle no
  (use-package org-roam
    :custom
    (org-roam-directory (file-truename "~/devel/org-roam-my-files/"))
    (org-roam-completion-everywhere t)
    (org-roam-dailies-capture-templates
     '(("d" "default" entry "* %<%I:%M %p>: %?"
        :if-new (file+head "%<%Y-%m-%d>.org" "#+title: %<%Y-%m-%d>\n"))))
    (org-roam-capture-templates
     '(("d" "default" plain
        "%?"
        :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
        :unnarrowed t)
       ("l" "programming language" plain
        "\n* Characteristics\n\n- Family: %?\n- Inspired by: \n\n* Reference:\n\n"
        :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
        :unnarrowed t)
       ("b" "book notes" plain
        (file "~/devel/dotfiles/org-roam/template-book.org")
        :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
        :unnarrowed t)))
    :bind (("C-c n i" . org-roam-node-insert)
           ("C-c n f" . org-roam-node-find)
           ("C-c n c" . org-roam-capture)
           ("C-c n l" . org-roam-buffer-toggle)
           ("C-c n g" . org-roam-graph)
           ("C-c n a a" . org-roam-alias-add)
           ("C-c n a d" . org-roam-alias-remove)
           ("C-c n t a" . org-roam-tag-add)
           ("C-c n t d" . org-roam-tag-remove)
           ;; Dailies
           ("C-c n d j" . org-roam-dailies-capture-today)
           ("C-c n d y" . org-roam-dailies-capture-yesterday)
           ("C-c n d t" . org-roam-dailies-capture-tomorrow)
           :map org-mode-map
           ("s-i" . completion-at-point))
    :config
    ;; Configure what sections are displayed in the Org-roam buffer:
    (setq org-roam-mode-sections
      (list #'org-roam-backlinks-section
            #'org-roam-reflinks-section
            #'org-roam-unlinked-references-section))
    ;; If you're using a vertical completion framework, you might want
    ;; a more informative completion interface.
    (setq org-roam-node-display-template
          (concat "${title:*} "
                  (propertize "${tags:30}" 'face 'org-tag)))
    ;; Setup Org-roam to run functions on file changes to maintain
    ;; cache consistency:
    (org-roam-db-autosync-mode)
    ;; If using org-roam-protocol
    (require 'org-roam-protocol))
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package deft
    :after org-roam
    :bind
    ;("C-c d" . deft)
    :custom
    (deft-recursive t)
    (deft-use-filename-as-title nil)
    (deft-use-filter-string-for-filename t)
    (deft-file-naming-rules '((noslash . "-")
                              (nospace . "-")
                              (case-fn . downcase)))
    (deft-text-mode 'org-mode)
    (deft-default-extension "org")
    (deft-directory org-roam-directory)
    (deft-auto-save-interval 300))
#+end_src

#+begin_src emacs-lisp :tangle no
  (use-package flyspell)
#+end_src

** Latex

#+begin_src emacs-lisp :tangle no
  (use-package tex
    :straight auctex)
#+end_src

** Babel

#+begin_src emacs-lisp :tangle no
  ;; Evalute Babel code without asking for confirmation.
  (set 'org-confirm-babel-evaluate nil)

  ;; Package org-tempo allows me to create Babel blocks with
  ;; templates starting with "<".
  (require 'org-tempo)
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("ocaml" . "src ocaml"))
  (add-to-list 'org-structure-template-alist '("bash" . "src bash"))
  (add-to-list 'org-structure-template-alist '("js" . "src js"))
  (add-to-list 'org-structure-template-alist '("json" . "src json"))

  ;; Enable Babel languages.
  (org-babel-do-load-languages
   'org-babel-load-languages '((ocaml . t)
                               (emacs-lisp . t)
                               (latex . t)
                               (js . t)))
#+end_src

** Standard ML

#+begin_src emacs-lisp :tangle no
  (use-package sml-mode)
#+end_src

** PDF

#+begin_src emacs-lisp
  (use-package pdf-tools
    :mode
    (("\\.pdf$" . pdf-view-mode))

    :custom
    ;; pdf-annot-activate-created-annotations t ;; automatically annotate highlights
    pdf-view-resize-factor 1.1 ;; 10%

    :bind
    (:map pdf-view-mode-map
          ;; normal isearch
          ("C-s" . isearch-forward)
          ;; custom keys
          ("h" . pdf-annot-add-highlight-markup-annotation)
          ("t" . pdf-annot-add-text-annotation)
          ("D" . pdf-annot-delete))

    :hook
    ((pdf-view-mode) . (lambda () (cua-mode 0)))

    :config
    (pdf-tools-install)
    (setq-default pdf-view-display-size 'fit-page)
    (setq-default pdf-annot-color-history
                  '("plum" "dark khaki" "coral" "cyan" "gold"
         		  (highlight (color . "gold")) (underline (color . "blue"))
         		  (squiggly (color . "orange")) (strike-out (color . "red"))))
    (customize-set-variable
     'display-buffer-alist
     '(("^\\*outline"
        display-buffer-in-side-window
        (side . right)
        (window-width . 0.35)
        (inhibit-switch-frame . t)))))
#+end_src

#+begin_src emacs-lisp
;; (use-package pdf-tools
;;   ;; :pin manual ;; manually update
;;   :config
;;   ;; initialise
;;   (pdf-tools-install)
;;   ;; open pdfs scaled to fit page
;;   (setq-default pdf-view-display-size 'fit-page)
;;   ;; automatically annotate highlights
;;   ;; (setq pdf-annot-activate-created-annotations t)
;;   ;; use normal isearch
;;   (define-key pdf-view-mode-map (kbd "C-s") 'isearch-forward)
;;   ;; turn off cua so copy works
;;   (add-hook 'pdf-view-mode-hook (lambda () (cua-mode 0)))
;;   ;; more fine-grained zooming
;;   (setq pdf-view-resize-factor 1.1)
;;   ;; keyboard shortcuts
;;   (define-key pdf-view-mode-map (kbd "h") 'pdf-annot-add-highlight-markup-annotation)
;;   (define-key pdf-view-mode-map (kbd "t") 'pdf-annot-add-text-annotation)
;;   (define-key pdf-view-mode-map (kbd "D") 'pdf-annot-delete))
#+end_src

#+begin_src emacs-lisp
  ;; (pdf-tools-install)
  ;; (setq pdf-annot-default-annotation-properties
  ;;       '((highlight
  ;;          (color . "gold"))
  ;;         (underline
  ;;          (color . "blue"))
  ;;         (squiggly
  ;;          (color . "orange"))
  ;;         (strike-out
  ;;          (color . "red"))))
#+end_src

** Scheme

#+begin_src emacs-lisp :tangle no
  (use-package geiser)
  (use-package geiser-guile)
#+end_src

** Rust

#+begin_src emacs-lisp :tangle no
  (use-package rust-mode
    :config
    ; Force indentation to use spaces.
    (indent-tabs-mode nil)
    (rust-enable-format-on-save)
    (prettify-symbols-mode))
#+end_src

** JSON

#+begin_src emacs-lisp :tangle no
  (use-package json-mode)
#+end_src

** Go

#+begin_src emacs-lisp :tangle no
  (use-package go-mode
    :hook (before-save . gofmt-before-save))
#+end_src

** Idris

#+begin_src emacs-lisp :tangle no
  (use-package idris-mode
    :custom
    (idris-interpreter-path "idris2"))

  ;; (use-package idris-mode
  ;;   :mode ("\\.l?idr\\'" . idris-mode)
  ;;   :config
  ;;   (after lsp-mode
  ;;     (add-to-list 'lsp-language-id-configuration '(idris-mode . "idris2"))
  ;;     (lsp-register-client
  ;;      (make-lsp-client
  ;;       :new-connection (lsp-stdio-connection "idris2-lsp")
  ;;       :major-modes '(idris-mode)
  ;;       :server-id 'idris2-lsp))
  ;;     )
  ;;     ;; (setq lsp-semantic-tokens-enable t) ;; Optionally enable semantic tokens
  ;;   (add-hook 'idris-mode-hook #'lsp!)

#+end_src

** LLVM

Syntax highlighting mode for LLVM assembly files:
#+begin_src emacs-lisp
  (setq load-path (cons (expand-file-name "~/devel/llvm-project/llvm/utils/emacs/") load-path))
  (require 'llvm-mode) ;; Enables automatically in files ending in .ll
#+end_src

The following =clang-format= configuration expects a =.clang-format= file that can
be generated with: ~$ clang-format -style=llvm -dump-config > .clang-format~

#+begin_src emacs-lisp
  (use-package clang-format
    :hook
    (c-mode . clang-format-on-save-mode))
#+end_src

** C

#+begin_src emacs-lisp :tangle no
  ;; Frama C
  (setq load-path (cons (expand-file-name "~/.opam/5.3.0/share/frama-c/share/emacs/") load-path))
  (autoload 'acsl-mode "acsl" "Major mode for editing ACSL code" t)
  (add-to-list 'lsp-language-id-configuration '(acsl-mode . "c"))
#+end_src

* Terminals

We use vterm with defaults for the momment.

#+begin_src emacs-lisp :tangle no
;; (use-package vterm)
#+end_src

* Dired

In dired, we bind some shortcuts and change the default sorting of files and
dirs.

#+begin_src emacs-lisp
  (use-package dired
    :straight nil ; Built-in
    :commands (dired dired-jump)
    :bind (
           ("C-x C-j" . dired-jump)
           :map my-other-map
           ("f" . find-file-other-window))
    :custom
    (delete-by-moving-to-trash t)
    (trash-directory "~/trash/")
    (file-name-shadow-mode t)
    (dired-listing-switches "-ltgo")
    :hook
    (dired-mode-hook . dired-hide-details-mode))
#+end_src
